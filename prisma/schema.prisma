generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  name          String?
  avatar        String?
  company       String?
  jobTitle      String?
  website       String?
  googleTokens  Json?
  emailQuota    Int         @default(500)
  emailsSentToday Int       @default(0)
  lastResetDate DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  campaigns     Campaign[]
  contacts      Contact[]
  templates     Template[]
  contactLists  ContactList[]
}

model ContactList {
  id          String      @id @default(cuid())
  name        String
  description String?
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  contacts    Contact[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId])
}

model Contact {
  id          String      @id @default(cuid())
  email       String
  name        String?
  firstName   String?
  lastName    String?
  phone       String?
  company     String?
  jobTitle    String?
  website     String?
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  tags        String[]
  customData  Json?
  source      String?
  notes       String?
  status      ContactStatus @default(ACTIVE)
  // New fields for better contact management
  linkedInUrl String?
  twitterHandle String?
  facebookUrl String?
  birthday    DateTime?
  gender      String?
  language    String?     @default("en")
  timezone    String?
  score       Int         @default(0)  // Lead scoring
  rating      Int?        // 1-5 star rating
  lastContactedAt DateTime?
  lastEngagedAt DateTime?
  emailVerified Boolean   @default(false)
  phoneVerified Boolean   @default(false)
  doNotEmail  Boolean     @default(false)
  doNotCall   Boolean     @default(false)
  // Relationships
  listId      String?
  list        ContactList? @relation(fields: [listId], references: [id], onDelete: SetNull)
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Tracking
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  emailLogs   EmailLog[]
  activities  ContactActivity[]
  segments    ContactSegment[]

  @@unique([email, userId])
  @@index([userId])
  @@index([listId])
  @@index([status])
  @@index([tags])
  @@index([company])
  @@index([score])
  @@index([lastContactedAt])
  @@index([createdAt])
}

model Template {
  id          String      @id @default(cuid())
  name        String
  description String?
  subject     String
  previewText String?
  htmlBody    String
  textBody    String?
  thumbnail   String?
  category    String?
  isPublic    Boolean     @default(false)
  tags        String[]
  // Performance tracking
  totalSent   Int         @default(0)
  totalOpened Int         @default(0)
  totalClicked Int        @default(0)
  avgOpenRate Float       @default(0)
  avgClickRate Float      @default(0)
  performanceScore Int    @default(0)
  lastUsedAt  DateTime?
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  campaigns   Campaign[]

  @@index([userId])
  @@index([category])
  @@index([performanceScore])
}

model Campaign {
  id          String      @id @default(cuid())
  name        String
  description String?
  status      CampaignStatus @default(DRAFT)
  templateId  String
  template    Template    @relation(fields: [templateId], references: [id])
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetTags  String[]
  scheduledAt DateTime?
  sentAt      DateTime?
  completedAt DateTime?
  totalRecipients Int     @default(0)
  totalSent   Int         @default(0)
  totalFailed Int         @default(0)
  totalOpened Int         @default(0)
  totalClicked Int        @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  emailLogs   EmailLog[]
  runs        CampaignRun[]

  @@index([userId])
  @@index([status])
}

model CampaignRun {
  id              String      @id @default(cuid())
  campaignId      String
  campaign        Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  runNumber       Int
  status          CampaignStatus @default(DRAFT)
  totalRecipients Int         @default(0)
  totalSent       Int         @default(0)
  totalFailed     Int         @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  emailLogs       EmailLog[]

  @@index([campaignId])
  @@unique([campaignId, runNumber])
}

model EmailLog {
  id          String      @id @default(cuid())
  campaignId  String
  campaign    Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  runId       String?
  run         CampaignRun? @relation(fields: [runId], references: [id], onDelete: SetNull)
  contactId   String
  contact     Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  status      EmailStatus
  error       String?
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?
  createdAt   DateTime    @default(now())

  @@index([campaignId])
  @@index([runId])
  @@index([contactId])
  @@index([status])
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  FAILED
  PAUSED
}

enum EmailStatus {
  PENDING
  SENT
  OPENED
  CLICKED
  FAILED
  BOUNCED
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  COMPLAINED
}

// Contact Activity Log for tracking interactions
model ContactActivity {
  id          String      @id @default(cuid())
  contactId   String
  contact     Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  type        ActivityType
  title       String
  description String?
  metadata    Json?
  userId      String
  createdAt   DateTime    @default(now())

  @@index([contactId])
  @@index([type])
  @@index([createdAt])
}

// Contact Segments for dynamic grouping
model ContactSegment {
  id          String      @id @default(cuid())
  name        String
  description String?
  conditions  Json        // Store filter conditions
  contactIds  String[]    // Cached contact IDs
  userId      String
  contacts    Contact[]
  isActive    Boolean     @default(true)
  lastUpdated DateTime    @default(now())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId])
  @@index([isActive])
}

// Contact Field Definitions for custom fields
model ContactField {
  id          String      @id @default(cuid())
  name        String
  label       String
  type        FieldType
  options     String[]    // For dropdown/multi-select
  isRequired  Boolean     @default(false)
  isActive    Boolean     @default(true)
  order       Int         @default(0)
  userId      String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([name, userId])
  @@index([userId])
  @@index([isActive])
}

// Contact Duplicates tracking
model ContactDuplicate {
  id              String      @id @default(cuid())
  contactId1      String
  contactId2      String
  similarityScore Float       // 0-100
  matchedFields   String[]    // Fields that matched
  status          DuplicateStatus @default(PENDING)
  resolvedBy      String?
  resolvedAt      DateTime?
  createdAt       DateTime    @default(now())

  @@unique([contactId1, contactId2])
  @@index([status])
  @@index([similarityScore])
}

enum ActivityType {
  EMAIL_SENT
  EMAIL_OPENED
  EMAIL_CLICKED
  EMAIL_BOUNCED
  CALL_MADE
  CALL_RECEIVED
  MEETING_SCHEDULED
  MEETING_COMPLETED
  NOTE_ADDED
  TAG_ADDED
  TAG_REMOVED
  STATUS_CHANGED
  LIST_CHANGED
  FORM_SUBMITTED
  WEBSITE_VISIT
  CUSTOM
}

enum FieldType {
  TEXT
  NUMBER
  EMAIL
  PHONE
  URL
  DATE
  BOOLEAN
  DROPDOWN
  MULTI_SELECT
  TEXTAREA
}

enum DuplicateStatus {
  PENDING
  MERGED
  IGNORED
  REVIEWED
}
