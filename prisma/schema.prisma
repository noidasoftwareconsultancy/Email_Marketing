generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  name          String?
  avatar        String?
  googleTokens  Json?
  emailQuota    Int         @default(500)
  emailsSentToday Int       @default(0)
  lastResetDate DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  campaigns     Campaign[]
  contacts      Contact[]
  templates     Template[]
  contactLists  ContactList[]
}

model ContactList {
  id          String      @id @default(cuid())
  name        String
  description String?
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  contacts    Contact[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId])
}

model Contact {
  id          String      @id @default(cuid())
  email       String
  name        String?
  firstName   String?
  lastName    String?
  phone       String?
  company     String?
  jobTitle    String?
  website     String?
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  tags        String[]
  customData  Json?
  source      String?
  notes       String?
  status      ContactStatus @default(ACTIVE)
  listId      String?
  list        ContactList? @relation(fields: [listId], references: [id], onDelete: SetNull)
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  emailLogs   EmailLog[]

  @@unique([email, userId])
  @@index([userId])
  @@index([listId])
  @@index([status])
  @@index([tags])
}

model Template {
  id          String      @id @default(cuid())
  name        String
  description String?
  subject     String
  previewText String?
  htmlBody    String
  textBody    String?
  thumbnail   String?
  category    String?
  isPublic    Boolean     @default(false)
  tags        String[]
  // Performance tracking
  totalSent   Int         @default(0)
  totalOpened Int         @default(0)
  totalClicked Int        @default(0)
  avgOpenRate Float       @default(0)
  avgClickRate Float      @default(0)
  performanceScore Int    @default(0)
  lastUsedAt  DateTime?
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  campaigns   Campaign[]

  @@index([userId])
  @@index([category])
  @@index([performanceScore])
}

model Campaign {
  id          String      @id @default(cuid())
  name        String
  description String?
  status      CampaignStatus @default(DRAFT)
  templateId  String
  template    Template    @relation(fields: [templateId], references: [id])
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetTags  String[]
  scheduledAt DateTime?
  sentAt      DateTime?
  completedAt DateTime?
  totalRecipients Int     @default(0)
  totalSent   Int         @default(0)
  totalFailed Int         @default(0)
  totalOpened Int         @default(0)
  totalClicked Int        @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  emailLogs   EmailLog[]

  @@index([userId])
  @@index([status])
}

model EmailLog {
  id          String      @id @default(cuid())
  campaignId  String
  campaign    Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId   String
  contact     Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  status      EmailStatus
  error       String?
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?
  createdAt   DateTime    @default(now())

  @@index([campaignId])
  @@index([contactId])
  @@index([status])
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  FAILED
  PAUSED
}

enum EmailStatus {
  PENDING
  SENT
  OPENED
  CLICKED
  FAILED
  BOUNCED
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  COMPLAINED
}
